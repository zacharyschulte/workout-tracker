<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="IRON">
    <meta name="application-name" content="IRON">
    <meta name="description" content="Workout tracker with templates, 1RM calculator, and progressive overload planning">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <title>IRON ‚Äî Workout Tracker</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiSVJPTiBXb3Jrb3V0IFRyYWNrZXIiLCJzaG9ydF9uYW1lIjoiSVJPTiIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMGEwYTBhIiwidGhlbWVfY29sb3IiOiIjMGEwYTBhIiwib3JpZW50YXRpb24iOiJwb3J0cmFpdCIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDE5MiAxOTInJTNFJTNDcmVjdCBmaWxsPSclMjMwYTBhMGEnIHdpZHRoPScxOTInIGhlaWdodD0nMTkyJy8lM0UlM0N0ZXh0IHg9Jzk2JyB5PScxMjAnIGZvbnQtc2l6ZT0nODAnIGZvbnQtZmFtaWx5PSdzYW5zLXNlcmlmJyBmb250LXdlaWdodD0nYm9sZCcgZmlsbD0nJTIzZmYzYjMwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyUzRUZFJTNDL3RleHQlM0UlM0Mvc3ZnJTNFIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect fill='%230a0a0a' width='32' height='32' rx='6'/%3E%3Ctext x='16' y='22' font-size='16' font-family='sans-serif' font-weight='bold' fill='%23ff3b30' text-anchor='middle'%3EFE%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect fill='%230a0a0a' width='180' height='180'/%3E%3Ctext x='90' y='115' font-size='72' font-family='sans-serif' font-weight='bold' fill='%23ff3b30' text-anchor='middle'%3EFE%3C/text%3E%3C/svg%3E">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* Ensure all form elements respect container width */
        input, select, textarea, button {
            max-width: 100%;
            box-sizing: border-box;
            font-size: 16px; /* Prevents iOS zoom on focus */
        }

        /* Focus styles for accessibility */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        button:focus-visible, .btn:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }

        :root {
            --bg: #0a0a0a;
            --surface: #141414;
            --surface-raised: #1a1a1a;
            --border: #2a2a2a;
            --text: #f5f5f5;
            --text-muted: #888;
            --accent: #ff3b30;
            --accent-glow: rgba(255, 59, 48, 0.3);
            --success: #30d158;
            --warning: #ff9f0a;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }

        .app {
            height: 100%;
            display: flex;
            flex-direction: column;
            max-width: 500px;
            margin: 0 auto;
        }

        header {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 26px;
            letter-spacing: 4px;
            background: linear-gradient(135deg, var(--accent), #ff6b5b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .icon-btn {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        main {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 80px;
            -webkit-overflow-scrolling: touch;
        }

        .tab-content.active { display: block; }

        .bottom-nav {
            display: flex;
            border-top: 1px solid var(--border);
            background: var(--surface);
            flex-shrink: 0;
            padding-bottom: var(--safe-bottom);
        }

        .nav-item {
            flex: 1;
            padding: 10px 4px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-family: inherit;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .nav-item.active { color: var(--accent); }
        .nav-item svg { width: 20px; height: 20px; }

        .section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 16px;
            letter-spacing: 2px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .card-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 6px;
        }

        .card-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 15px;
            letter-spacing: 2px;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #ff6b5b);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #28a745);
            color: white;
        }

        .btn-secondary {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .btn-danger {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        /* Forms */
        .form-group { margin-bottom: 14px; }

        .form-label {
            display: block;
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            overflow: hidden;
        }

        .form-row > * {
            min-width: 0;
        }

        select.form-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 32px;
            min-width: 0;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--surface);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 22px;
            letter-spacing: 2px;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 16px;
        }

        /* Template exercise entry */
        .exercise-entry {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .exercise-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .exercise-num {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 12px;
            color: var(--accent);
            letter-spacing: 1px;
        }

        .remove-btn {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 59, 48, 0.2);
            color: var(--accent);
            cursor: pointer;
            font-size: 14px;
        }

        .exercise-fields {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .exercise-field {
            width: 100%;
            padding: 10px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
            font-size: 13px;
            min-width: 0;
            box-sizing: border-box;
        }

        .exercise-field:focus {
            outline: none;
            border-color: var(--accent);
        }

        .exercise-field-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            overflow: hidden;
        }

        .exercise-field-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }

        .exercise-field-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* v4 - Exercise picker pills */
        .exercise-pill {
            padding: 6px 10px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .exercise-pill:hover, .exercise-pill:focus {
            background: var(--surface-raised);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* v4 - Text button */
        .btn-text {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            padding: 4px 8px;
            text-decoration: underline;
        }

        .btn-text:hover {
            color: #ff6b5b;
        }

        .add-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 2px dashed var(--border);
            border-radius: 10px;
            color: var(--text-muted);
            font-family: inherit;
            font-size: 13px;
            cursor: pointer;
            margin-bottom: 14px;
        }

        .add-btn:active {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Active Workout */
        .workout-header {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .workout-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            letter-spacing: 2px;
        }

        .workout-timer {
            font-size: 14px;
            color: var(--accent);
            font-weight: 600;
        }

        .exercise-block {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .exercise-block-header {
            padding: 12px 14px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exercise-block-name {
            font-weight: 600;
            font-size: 14px;
        }

        .exercise-block-target {
            font-size: 11px;
            color: var(--text-muted);
        }

        .set-list { padding: 10px; }

        .set-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 6px;
            overflow: hidden;
        }

        .set-row.completed {
            background: rgba(48, 209, 88, 0.1);
            border: 1px solid rgba(48, 209, 88, 0.3);
        }

        .set-num {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 14px;
            color: var(--text-muted);
            width: 24px;
            text-align: center;
            flex-shrink: 0;
        }

        .set-row.completed .set-num { color: var(--success); }

        .set-input {
            flex: 1;
            padding: 10px 8px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: inherit;
            font-size: 13px;
            text-align: center;
            min-width: 0;
            box-sizing: border-box;
        }

        .set-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .set-input.small {
            flex: 0 0 60px;
            width: 60px;
        }

        .set-check {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 18px;
            flex-shrink: 0;
        }

        .set-check.checked {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .add-set-btn {
            width: calc(100% - 20px);
            margin: 0 10px 10px;
            padding: 10px;
            background: transparent;
            border: 1px dashed var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
        }

        /* Calculator */
        .calc-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 14px;
            overflow: hidden;
        }

        .calc-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 16px;
            letter-spacing: 2px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .calc-results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 14px;
            overflow: hidden;
        }

        .calc-result {
            background: var(--bg);
            border-radius: 10px;
            padding: 14px;
            text-align: center;
            min-width: 0;
        }

        .calc-result.highlight {
            background: rgba(255,59,48,0.1);
            border: 1px solid var(--accent);
        }

        .calc-result-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 32px;
            line-height: 1;
        }

        .calc-result.highlight .calc-result-value { color: var(--accent); }

        .calc-result-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }

        .percentage-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-top: 14px;
        }

        .pct-item {
            background: var(--bg);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
        }

        .pct-item.active {
            background: rgba(255,59,48,0.1);
            border: 1px solid var(--accent);
        }

        .pct-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
        }

        .pct-item.active .pct-value { color: var(--accent); }

        .pct-label {
            font-size: 9px;
            color: var(--text-muted);
        }

        /* Standards */
        .standards-bar {
            position: relative;
            height: 20px;
            margin: 12px 0 6px;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
        }

        .standards-segment { flex: 1; }
        .standards-segment.beginner { background: #64748b; }
        .standards-segment.novice { background: #3b82f6; }
        .standards-segment.intermediate { background: #16a34a; }
        .standards-segment.advanced { background: #eab308; }
        .standards-segment.elite { background: #ef4444; }

        .standards-marker {
            position: absolute;
            top: -2px;
            width: 4px;
            height: 24px;
            background: white;
            border-radius: 2px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
            transition: left 0.3s;
        }

        .standards-labels {
            display: flex;
            justify-content: space-between;
            font-size: 8px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .standards-table {
            margin-top: 12px;
            font-size: 11px;
        }

        .standards-row {
            display: grid;
            grid-template-columns: 1.2fr repeat(5, 1fr);
            gap: 4px;
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
        }

        .standards-row.header {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .standards-cell { text-align: center; }
        .standards-cell.name { text-align: left; font-weight: 600; }
        .standards-cell.current { color: var(--accent); font-weight: 600; }
        .standards-cell .working { font-size: 9px; opacity: 0.6; }

        /* Progress Planner */
        .planner-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
            overflow: hidden;
        }

        .planner-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }

        .planner-field.full { grid-column: 1 / -1; }

        .planner-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .planner-input {
            width: 100%;
            padding: 10px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
            font-size: 13px;
            min-width: 0;
            box-sizing: border-box;
        }

        .planner-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        select.planner-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px;
        }

        .progress-timeline {
            margin-top: 16px;
        }

        .progress-week {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .progress-week.current {
            background: rgba(255,59,48,0.1);
            margin: 0 -14px;
            padding: 10px 14px;
            border-radius: 8px;
        }

        .progress-week-num {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 14px;
            color: var(--text-muted);
            width: 50px;
        }

        .progress-week.current .progress-week-num { color: var(--accent); }

        .progress-week-weight {
            font-weight: 600;
            font-size: 15px;
            flex: 1;
        }

        .progress-week-working {
            font-size: 12px;
            color: var(--text-muted);
        }

        .progress-week-bar {
            width: 60px;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin-left: 10px;
        }

        .progress-week-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 40px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 13px;
            margin-bottom: 16px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--surface-raised);
            border: 1px solid var(--border);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 12px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 300;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: var(--success);
            color: var(--success);
        }

        /* FAB */
        .fab {
            position: fixed;
            bottom: 75px;
            right: 20px;
            width: 54px;
            height: 54px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #ff6b5b);
            border: none;
            color: white;
            font-size: 26px;
            cursor: pointer;
            box-shadow: 0 4px 15px var(--accent-glow);
            z-index: 100;
        }

        /* History card */
        .history-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .history-card:active {
            border-color: var(--accent);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .history-name {
            font-weight: 600;
            font-size: 14px;
        }

        .history-date {
            font-size: 11px;
            color: var(--text-muted);
        }

        .history-summary {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* Saved plans */
        .plan-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
        }

        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .plan-name {
            font-weight: 600;
            font-size: 14px;
        }

        .plan-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        .plan-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
        }

        .plan-progress-bar {
            flex: 1;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .plan-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--success));
            border-radius: 4px;
        }

        .plan-progress-text {
            font-size: 11px;
            color: var(--text-muted);
            min-width: 80px;
            text-align: right;
        }

        /* Current stats from 1RM */
        .current-stats {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 14px;
            overflow: hidden;
        }

        .current-stats-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .current-stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            overflow: hidden;
        }

        .current-stat {
            background: var(--surface);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            min-width: 0;
            overflow: hidden;
        }

        .current-stat.highlight {
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid var(--accent);
        }

        .current-stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 24px;
            line-height: 1;
        }

        .current-stat.highlight .current-stat-value {
            color: var(--accent);
        }

        .current-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .warning-box {
            background: rgba(255, 159, 10, 0.1);
            border: 1px solid var(--warning);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 14px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            font-size: 12px;
            color: var(--warning);
        }

        .warning-box span {
            font-size: 16px;
        }

        .goal-suggestions {
            margin-bottom: 14px;
        }

        .goal-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .goal-chip {
            padding: 8px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text);
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .goal-chip:active {
            border-color: var(--accent);
            background: rgba(255, 59, 48, 0.1);
        }

        .goal-chip .chip-label {
            color: var(--text-muted);
            font-size: 9px;
            display: block;
            margin-top: 2px;
        }

        .goal-chip.milestone {
            border-color: var(--warning);
            background: rgba(255, 159, 10, 0.1);
        }

        .goal-chip.level {
            border-color: var(--success);
            background: rgba(48, 209, 88, 0.1);
        }

        .goal-chip.next {
            border-color: var(--accent);
            background: rgba(255, 59, 48, 0.15);
        }

        .planner-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="logo">IRON</div>
            <button type="button" class="icon-btn" id="settings-btn" aria-label="Settings">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"></path>
                </svg>
            </button>
        </header>

        <main>
            <!-- Tab: Workout -->
            <div class="tab-content active" id="tab-workout">
                <div id="workout-view">
                    <div class="active-workout" id="active-workout" style="display: none;">
                        <div class="workout-header">
                            <span class="workout-name" id="active-workout-name">Workout</span>
                            <span class="workout-timer" id="workout-timer">00:00</span>
                        </div>
                        <div id="active-exercises"></div>
                        <div class="workout-actions" style="margin-top: 16px; padding-bottom: 20px;">
                            <button type="button" class="btn btn-success" id="finish-btn" style="margin-bottom: 8px;">‚úì Finish Workout</button>
                            <button type="button" class="btn btn-secondary" id="cancel-btn">Cancel</button>
                        </div>
                    </div>

                    <div id="template-view">
                        <h2 class="section-title">Start Workout</h2>
                        <div id="template-list"></div>
                    </div>
                </div>
            </div>

            <!-- Tab: 1RM Calculator -->
            <div class="tab-content" id="tab-calc">
                <div class="calc-section">
                    <h3 class="calc-title">Your Profile</h3>
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Body Weight</label>
                            <input type="number" inputmode="decimal" class="form-input" id="profile-weight" placeholder="180" min="50" max="500" step="0.1">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Sex</label>
                            <select class="form-input" id="profile-sex">
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" id="save-profile-btn" style="margin-top: 12px;">Save Profile</button>
                </div>

                <div class="calc-section">
                    <h3 class="calc-title">Calculate 1RM</h3>
                    <div class="form-group">
                        <label class="form-label">Exercise</label>
                        <select class="form-input" id="calc-exercise">
                            <option value="bench">Bench Press</option>
                            <option value="squat">Back Squat</option>
                            <option value="deadlift">Deadlift</option>
                            <option value="ohp">Overhead Press</option>
                            <option value="row">Barbell Row</option>
                            <option value="front-squat">Front Squat</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Weight (lbs)</label>
                            <input type="number" inputmode="decimal" class="form-input" id="calc-weight" placeholder="185" min="0" max="1500" step="0.5">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Reps</label>
                            <input type="number" inputmode="numeric" class="form-input" id="calc-reps" placeholder="5" min="1" max="100" step="1">
                        </div>
                    </div>

                    <div class="calc-results">
                        <div class="calc-result highlight">
                            <div class="calc-result-value" id="calc-1rm">‚Äî</div>
                            <div class="calc-result-label">Est. 1RM</div>
                        </div>
                        <div class="calc-result" id="current-pct-box">
                            <div class="calc-result-value" id="calc-current-pct">‚Äî</div>
                            <div class="calc-result-label">Your Current %</div>
                        </div>
                    </div>

                    <div id="current-weight-info" style="display: none; background: var(--bg); border-radius: 8px; padding: 12px; margin-top: 12px; font-size: 12px; line-height: 1.6;">
                        <div style="color: var(--text-muted);">You're lifting <strong style="color: var(--text);" id="info-weight">135</strong> lbs at <strong style="color: var(--accent);" id="info-pct">79%</strong> of your max</div>
                        <div style="color: var(--text-muted); margin-top: 6px; font-size: 11px;">
                            <span style="color: var(--success);">‚óè</span> Good for <span id="info-rep-range">6-8 reps</span> (strength-hypertrophy)
                        </div>
                    </div>

                    <div id="standards-display" style="display: none;">
                        <div class="form-label" style="margin-top: 14px;">Your Level</div>
                        <div class="standards-bar">
                            <div class="standards-segment beginner"></div>
                            <div class="standards-segment novice"></div>
                            <div class="standards-segment intermediate"></div>
                            <div class="standards-segment advanced"></div>
                            <div class="standards-segment elite"></div>
                            <div class="standards-marker" id="standards-marker"></div>
                        </div>
                        <div class="standards-labels">
                            <span>Beg</span><span>Nov</span><span>Int</span><span>Adv</span><span>Elite</span>
                        </div>
                        <div id="standards-info" style="margin-top: 10px; font-size: 12px; color: var(--text-muted);"></div>
                    </div>

                    <button type="button" class="btn btn-primary" id="save-1rm-btn" style="margin-top: 14px; display: none;">Save Estimate</button>

                    <div class="percentage-grid" id="percentage-grid"></div>
                </div>

                <div class="calc-section">
                    <h3 class="calc-title">Strength Standards (1RM)</h3>
                    <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">Working weight (70%) in parentheses</p>
                    <div id="standards-table"></div>
                </div>
            </div>

            <!-- Tab: Progress Planner -->
            <div class="tab-content" id="tab-progress">
                <div class="calc-section">
                    <h3 class="calc-title">Progressive Overload Planner</h3>
                    <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 12px;">Plan your working weight progression</p>

                    <div class="form-group">
                        <label class="form-label">Exercise</label>
                        <select class="form-input" id="plan-exercise" onchange="loadExerciseData()">
                            <option value="bench">Bench Press</option>
                            <option value="squat">Back Squat</option>
                            <option value="deadlift">Deadlift</option>
                            <option value="ohp">Overhead Press</option>
                            <option value="row">Barbell Row</option>
                            <option value="front-squat">Front Squat</option>
                        </select>
                    </div>

                    <div id="current-stats" class="current-stats" style="display: none;">
                        <div class="current-stats-label">From your saved estimate:</div>
                        <div class="current-stats-row">
                            <div class="current-stat">
                                <div class="current-stat-value" id="plan-current-1rm">‚Äî</div>
                                <div class="current-stat-label">Est. 1RM</div>
                            </div>
                            <div class="current-stat highlight">
                                <div class="current-stat-value" id="plan-current-working">‚Äî</div>
                                <div class="current-stat-label">You Lifted</div>
                            </div>
                        </div>
                    </div>

                    <div id="no-estimate-warning" class="warning-box" style="display: none;">
                        <span>‚ö†Ô∏è</span>
                        <div>
                            <strong>No saved estimate</strong><br>
                            <span style="font-size: 11px;">Go to the 1RM tab to calculate and save your current max, or enter manually below.</span>
                        </div>
                    </div>

                    <div class="planner-config">
                        <div class="planner-field">
                            <span class="planner-label">Current Working Weight</span>
                            <input type="number" inputmode="decimal" class="planner-input" id="plan-current" placeholder="130" min="0" max="1500" step="2.5">
                        </div>
                        <div class="planner-field">
                            <span class="planner-label">Goal Working Weight</span>
                            <input type="number" inputmode="decimal" class="planner-input" id="plan-goal" placeholder="185" min="0" max="1500" step="2.5">
                        </div>
                    </div>

                    <div id="goal-suggestions" class="goal-suggestions" style="display: none;">
                        <span class="planner-label">Suggested Goals</span>
                        <div class="goal-chips" id="goal-chips">
                            <!-- Goal suggestions rendered here -->
                        </div>
                    </div>

                    <div class="planner-config" style="margin-top: 14px;">
                        <div class="planner-field">
                            <span class="planner-label">Workouts/Week</span>
                            <select class="planner-input" id="plan-frequency">
                                <option value="1">1√ó/week</option>
                                <option value="2" selected>2√ó/week</option>
                                <option value="3">3√ó/week</option>
                            </select>
                        </div>
                        <div class="planner-field">
                            <span class="planner-label">Weekly Increase</span>
                            <select class="planner-input" id="plan-increment">
                                <option value="2.5">2.5 lbs</option>
                                <option value="5" selected>5 lbs</option>
                                <option value="10">10 lbs</option>
                            </select>
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary" id="generate-plan-btn">Generate Plan</button>

                    <div class="progress-timeline" id="progress-timeline" style="display: none;"></div>
                </div>

                <div id="saved-plans-section">
                    <h2 class="section-title" style="margin-top: 20px;">Saved Plans</h2>
                    <div id="saved-plans-list"></div>
                </div>
            </div>

            <!-- Tab: History -->
            <div class="tab-content" id="tab-history">
                <h2 class="section-title">Workout History</h2>
                <div id="history-list"></div>
            </div>

            <!-- Tab: Settings -->
            <div class="tab-content" id="tab-settings">
                <h2 class="section-title">Settings</h2>
                <div class="card">
                    <div class="card-title">Data Management</div>
                    <button type="button" class="btn btn-secondary" id="export-btn" style="margin-top: 10px;">Export All Data</button>
                    <button type="button" class="btn btn-secondary" id="import-btn" style="margin-top: 8px;">Import Data</button>
                    <button type="button" class="btn btn-danger" id="clear-btn" style="margin-top: 8px;">Clear All Data</button>
                </div>
                <input type="file" id="import-input" accept=".json" style="display: none;">
            </div>
        </main>

        <nav class="bottom-nav" role="navigation" aria-label="Main navigation">
            <button type="button" class="nav-item active" data-tab="workout" aria-label="Workout tab" aria-selected="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M6.5 6.5h11M6.5 17.5h11M4 12h16M2 6.5a2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5v11a2.5 2.5 0 0 1-2.5 2.5 2.5 2.5 0 0 1-2.5-2.5zM17 6.5a2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5v11a2.5 2.5 0 0 1-2.5 2.5 2.5 2.5 0 0 1-2.5-2.5z"></path>
                </svg>
                Workout
            </button>
            <button type="button" class="nav-item" data-tab="calc" aria-label="1RM Calculator tab">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <rect x="4" y="2" width="16" height="20" rx="2"></rect>
                    <line x1="8" y1="6" x2="16" y2="6"></line>
                    <line x1="8" y1="10" x2="16" y2="10"></line>
                    <line x1="8" y1="14" x2="12" y2="14"></line>
                    <line x1="8" y1="18" x2="12" y2="18"></line>
                </svg>
                1RM
            </button>
            <button type="button" class="nav-item" data-tab="progress" aria-label="Progress Planner tab">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                    <polyline points="17 6 23 6 23 12"></polyline>
                </svg>
                Progress
            </button>
            <button type="button" class="nav-item" data-tab="history" aria-label="History tab">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                History
            </button>
        </nav>

        <button type="button" class="fab" id="fab-btn" aria-label="Create new template">+</button>
    </div>

    <!-- Template Modal -->
    <div class="modal-overlay" id="template-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="template-modal-title">New Template</h3>
                <button type="button" class="close-btn" id="close-template-modal" aria-label="Close modal">√ó</button>
            </div>
            <form id="template-form" onsubmit="return false;" autocomplete="off">
                <div class="form-group">
                    <label class="form-label">Template Name</label>
                    <input type="text" class="form-input" id="template-name" placeholder="e.g., Push Day, Leg Day..." required>
                </div>

                <!-- Exercise Picker Section -->
                <div class="form-group" id="exercise-picker-section">
                    <label class="form-label">Add Exercises</label>
                    <input type="text" class="form-input" id="exercise-search" placeholder="üîç Search exercises..." style="margin-bottom: 12px;">

                    <div id="exercise-categories" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 8px;">
                        <!-- Categories will be populated by JS -->
                    </div>

                    <button type="button" class="btn btn-secondary" id="create-custom-exercise-btn" style="margin-top: 8px; width: 100%;">+ Create Custom Exercise</button>
                </div>

                <!-- Added Exercises -->
                <div class="form-group">
                    <label class="form-label">Template Exercises</label>
                    <div id="template-exercises"></div>
                </div>

                <input type="hidden" id="editing-template-id">
                <button type="submit" class="btn btn-primary">Save Template</button>
                <button type="button" class="btn btn-danger" id="delete-template-btn" style="margin-top: 8px; display: none;">Delete Template</button>
            </form>
        </div>
    </div>

    <!-- Custom Exercise Modal -->
    <div class="modal-overlay" id="custom-exercise-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Create Custom Exercise</h3>
                <button type="button" class="close-btn" id="close-custom-exercise-modal" aria-label="Close modal">√ó</button>
            </div>
            <form id="custom-exercise-form" onsubmit="return false;" autocomplete="off">
                <div class="form-group">
                    <label class="form-label">Exercise Name</label>
                    <input type="text" class="form-input" id="custom-exercise-name" placeholder="e.g., Hack Squat" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-input" id="custom-exercise-category">
                        <option value="strength">Strength</option>
                        <option value="cardio">Cardio</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Equipment</label>
                    <select class="form-input" id="custom-exercise-equipment">
                        <option value="barbell">Barbell</option>
                        <option value="dumbbell">Dumbbell</option>
                        <option value="kettlebell">Kettlebell</option>
                        <option value="cable">Cable</option>
                        <option value="machine">Machine</option>
                        <option value="bodyweight">Bodyweight</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Muscle Group</label>
                    <select class="form-input" id="custom-exercise-muscle">
                        <option value="chest">Chest</option>
                        <option value="back">Back</option>
                        <option value="shoulders">Shoulders</option>
                        <option value="arms">Arms</option>
                        <option value="legs">Legs</option>
                        <option value="core">Core</option>
                        <option value="fullbody">Full Body</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Create Exercise</button>
            </form>
        </div>
    </div>

    <!-- View Workout Modal -->
    <div class="modal-overlay" id="workout-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="workout-modal-title">Workout</h3>
                <button type="button" class="close-btn" id="close-workout-modal" aria-label="Close modal">√ó</button>
            </div>
            <p id="workout-modal-date" style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;"></p>
            <div id="workout-modal-exercises"></div>
            <button type="button" class="btn btn-danger" id="delete-workout-btn" style="margin-top: 14px;">Delete Workout</button>
        </div>
    </div>

    <!-- Save Plan Modal -->
    <div class="modal-overlay" id="plan-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Save Plan</h3>
                <button type="button" class="close-btn" id="close-plan-modal" aria-label="Close modal">√ó</button>
            </div>
            <div class="form-group">
                <label class="form-label">Plan Name</label>
                <input type="text" class="form-input" id="plan-name" placeholder="e.g., Bench to 225">
            </div>
            <button type="button" class="btn btn-primary" id="confirm-save-plan">Save Plan</button>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal" style="max-width: 320px; text-align: center;">
            <h3 class="modal-title" id="confirm-title">Confirm</h3>
            <p id="confirm-message" style="color: var(--text-muted); margin: 16px 0; font-size: 14px;"></p>
            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn btn-secondary" id="confirm-no" style="flex: 1;">No</button>
                <button type="button" class="btn btn-danger" id="confirm-yes" style="flex: 1; background: var(--accent); color: white;">Yes</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Storage keys
        const KEYS = {
            templates: 'iron_templates_v4',
            history: 'iron_history_v4',
            profile: 'iron_profile_v4',
            exercises: 'iron_exercises_v4',
            plans: 'iron_plans_v4'
        };

        // IRON v4 - Comprehensive Exercise Library
        const EXERCISE_LIBRARY = {
            // Strength - Barbell
            'bench-press': { id: 'bench-press', name: 'Bench Press', category: 'strength', equipment: 'barbell', muscleGroup: 'chest', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 5 },
            'incline-bench': { id: 'incline-bench', name: 'Incline Bench Press', category: 'strength', equipment: 'barbell', muscleGroup: 'chest', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 5 },
            'back-squat': { id: 'back-squat', name: 'Back Squat', category: 'strength', equipment: 'barbell', muscleGroup: 'legs', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 10 },
            'front-squat': { id: 'front-squat', name: 'Front Squat', category: 'strength', equipment: 'barbell', muscleGroup: 'legs', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 5 },
            'deadlift': { id: 'deadlift', name: 'Deadlift', category: 'strength', equipment: 'barbell', muscleGroup: 'back', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 10 },
            'romanian-deadlift': { id: 'romanian-deadlift', name: 'Romanian Deadlift', category: 'strength', equipment: 'barbell', muscleGroup: 'legs', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 10 },
            'overhead-press': { id: 'overhead-press', name: 'Overhead Press', category: 'strength', equipment: 'barbell', muscleGroup: 'shoulders', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 2.5 },
            'barbell-row': { id: 'barbell-row', name: 'Barbell Row', category: 'strength', equipment: 'barbell', muscleGroup: 'back', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 5 },
            'barbell-curl': { id: 'barbell-curl', name: 'Barbell Curl', category: 'strength', equipment: 'barbell', muscleGroup: 'arms', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 2.5 },

            // Strength - Dumbbell
            'db-bench': { id: 'db-bench', name: 'Dumbbell Bench Press', category: 'strength', equipment: 'dumbbell', muscleGroup: 'chest', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 5 },
            'db-row': { id: 'db-row', name: 'Dumbbell Row', category: 'strength', equipment: 'dumbbell', muscleGroup: 'back', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 5 },
            'lateral-raise': { id: 'lateral-raise', name: 'Lateral Raises', category: 'strength', equipment: 'dumbbell', muscleGroup: 'shoulders', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 2.5 },
            'db-curl': { id: 'db-curl', name: 'Dumbbell Curls', category: 'strength', equipment: 'dumbbell', muscleGroup: 'arms', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 2.5 },
            'tricep-extension': { id: 'tricep-extension', name: 'Tricep Extensions', category: 'strength', equipment: 'dumbbell', muscleGroup: 'arms', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 2.5 },
            'db-lunge': { id: 'db-lunge', name: 'Dumbbell Lunges', category: 'strength', equipment: 'dumbbell', muscleGroup: 'legs', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 5 },
            'goblet-squat': { id: 'goblet-squat', name: 'Goblet Squat', category: 'strength', equipment: 'dumbbell', muscleGroup: 'legs', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 5 },
            'db-shoulder-press': { id: 'db-shoulder-press', name: 'Dumbbell Shoulder Press', category: 'strength', equipment: 'dumbbell', muscleGroup: 'shoulders', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 2.5 },
            'db-chest-fly': { id: 'db-chest-fly', name: 'Dumbbell Chest Fly', category: 'strength', equipment: 'dumbbell', muscleGroup: 'chest', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 2.5 },

            // Strength - Kettlebell
            'kb-swing': { id: 'kb-swing', name: 'Kettlebell Swing', category: 'strength', equipment: 'kettlebell', muscleGroup: 'fullbody', hasStandards: false, trackingType: 'weight-reps', weightIncrement: 5 },
            'kb-goblet-squat': { id: 'kb-goblet-squat', name: 'Kettlebell Goblet Squat', category: 'strength', equipment: 'kettlebell', muscleGroup: 'legs', hasStandards: false, trackingType: 'weight-reps', weightIncrement: 5 },
            'turkish-getup': { id: 'turkish-getup', name: 'Turkish Get-up', category: 'strength', equipment: 'kettlebell', muscleGroup: 'fullbody', hasStandards: false, trackingType: 'weight-reps', weightIncrement: 5 },
            'farmers-walk': { id: 'farmers-walk', name: 'Farmers Walk', category: 'strength', equipment: 'kettlebell', muscleGroup: 'fullbody', hasStandards: false, trackingType: 'weight-time', weightIncrement: 5 },
            'kb-clean-press': { id: 'kb-clean-press', name: 'Kettlebell Clean & Press', category: 'strength', equipment: 'kettlebell', muscleGroup: 'fullbody', hasStandards: false, trackingType: 'weight-reps', weightIncrement: 5 },

            // Strength - Cable/Machine
            'lat-pulldown': { id: 'lat-pulldown', name: 'Lat Pulldown', category: 'strength', equipment: 'cable', muscleGroup: 'back', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 5 },
            'cable-row': { id: 'cable-row', name: 'Cable Row', category: 'strength', equipment: 'cable', muscleGroup: 'back', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 5 },
            'leg-press': { id: 'leg-press', name: 'Leg Press', category: 'strength', equipment: 'machine', muscleGroup: 'legs', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 10 },
            'leg-curl': { id: 'leg-curl', name: 'Leg Curl', category: 'strength', equipment: 'machine', muscleGroup: 'legs', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 5 },
            'leg-extension': { id: 'leg-extension', name: 'Leg Extension', category: 'strength', equipment: 'machine', muscleGroup: 'legs', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 5 },
            'cable-fly': { id: 'cable-fly', name: 'Cable Fly', category: 'strength', equipment: 'cable', muscleGroup: 'chest', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 2.5 },
            'tricep-pushdown': { id: 'tricep-pushdown', name: 'Tricep Pushdown', category: 'strength', equipment: 'cable', muscleGroup: 'arms', hasStandards: true, trackingType: 'weight-reps', weightIncrement: 2.5 },

            // Strength - Bodyweight
            'pullup': { id: 'pullup', name: 'Pull-ups', category: 'strength', equipment: 'bodyweight', muscleGroup: 'back', hasStandards: false, trackingType: 'weight-reps', weightIncrement: 5 },
            'pushup': { id: 'pushup', name: 'Push-ups', category: 'strength', equipment: 'bodyweight', muscleGroup: 'chest', hasStandards: false, trackingType: 'weight-reps', weightIncrement: 0 },
            'dip': { id: 'dip', name: 'Dips', category: 'strength', equipment: 'bodyweight', muscleGroup: 'chest', hasStandards: false, trackingType: 'weight-reps', weightIncrement: 5 },
            'plank': { id: 'plank', name: 'Plank', category: 'strength', equipment: 'bodyweight', muscleGroup: 'core', hasStandards: false, trackingType: 'weight-time', weightIncrement: 0 },

            // Cardio
            'treadmill': { id: 'treadmill', name: 'Treadmill', category: 'cardio', equipment: 'machine', muscleGroup: 'fullbody', hasStandards: false, trackingType: 'cardio', cardioFields: ['time', 'speed', 'incline'] },
            'elliptical': { id: 'elliptical', name: 'Elliptical', category: 'cardio', equipment: 'machine', muscleGroup: 'fullbody', hasStandards: false, trackingType: 'cardio', cardioFields: ['time', 'resistance'] },
            'stationary-bike': { id: 'stationary-bike', name: 'Stationary Bike', category: 'cardio', equipment: 'machine', muscleGroup: 'fullbody', hasStandards: false, trackingType: 'cardio', cardioFields: ['time', 'resistance'] },
            'rowing-machine': { id: 'rowing-machine', name: 'Rowing Machine', category: 'cardio', equipment: 'machine', muscleGroup: 'fullbody', hasStandards: false, trackingType: 'cardio', cardioFields: ['time', 'distance'] },
            'stair-climber': { id: 'stair-climber', name: 'Stair Climber', category: 'cardio', equipment: 'machine', muscleGroup: 'fullbody', hasStandards: false, trackingType: 'cardio', cardioFields: ['time', 'resistance'] },
            'jump-rope': { id: 'jump-rope', name: 'Jump Rope', category: 'cardio', equipment: 'bodyweight', muscleGroup: 'fullbody', hasStandards: false, trackingType: 'cardio', cardioFields: ['time'] }
        };

        // Strength standards (multipliers of bodyweight)
        const STANDARDS = {
            male: {
                'bench-press': [0.50, 0.75, 1.00, 1.50, 2.00],
                'incline-bench': [0.50, 0.75, 1.00, 1.50, 2.00],
                'back-squat': [0.75, 1.00, 1.50, 2.00, 2.75],
                'front-squat': [0.60, 0.85, 1.15, 1.50, 1.90],
                'deadlift': [1.00, 1.25, 1.75, 2.25, 3.00],
                'overhead-press': [0.35, 0.50, 0.75, 1.00, 1.25],
                'barbell-row': [0.40, 0.55, 0.75, 1.00, 1.25],
                'romanian-deadlift': [0.75, 1.00, 1.35, 1.75, 2.25],
                'barbell-curl': [0.30, 0.40, 0.55, 0.70, 0.90],
                'db-bench': [0.20, 0.30, 0.40, 0.60, 0.80],
                'db-row': [0.20, 0.30, 0.40, 0.55, 0.70],
                'db-shoulder-press': [0.15, 0.20, 0.30, 0.40, 0.50],
                'lateral-raise': [0.05, 0.08, 0.12, 0.17, 0.22],
                'db-curl': [0.08, 0.12, 0.17, 0.23, 0.30],
                'lat-pulldown': [0.50, 0.70, 0.90, 1.20, 1.50],
                'cable-row': [0.50, 0.70, 0.90, 1.20, 1.50],
                'leg-press': [1.50, 2.00, 2.75, 3.50, 4.50],
                'leg-curl': [0.25, 0.35, 0.50, 0.65, 0.85],
                'leg-extension': [0.30, 0.40, 0.55, 0.75, 1.00],
                'cable-fly': [0.15, 0.20, 0.30, 0.40, 0.55],
                'tricep-pushdown': [0.20, 0.30, 0.45, 0.60, 0.80]
            },
            female: {
                'bench-press': [0.25, 0.40, 0.60, 0.85, 1.15],
                'incline-bench': [0.25, 0.40, 0.60, 0.85, 1.15],
                'back-squat': [0.50, 0.75, 1.00, 1.35, 1.75],
                'front-squat': [0.40, 0.55, 0.75, 1.00, 1.30],
                'deadlift': [0.65, 0.90, 1.25, 1.65, 2.10],
                'overhead-press': [0.20, 0.30, 0.45, 0.60, 0.80],
                'barbell-row': [0.25, 0.40, 0.55, 0.70, 0.90],
                'romanian-deadlift': [0.50, 0.70, 0.95, 1.25, 1.60],
                'barbell-curl': [0.20, 0.25, 0.35, 0.45, 0.60],
                'db-bench': [0.10, 0.15, 0.25, 0.35, 0.45],
                'db-row': [0.10, 0.18, 0.25, 0.35, 0.45],
                'db-shoulder-press': [0.08, 0.12, 0.18, 0.25, 0.32],
                'lateral-raise': [0.03, 0.05, 0.08, 0.11, 0.15],
                'db-curl': [0.05, 0.08, 0.11, 0.15, 0.20],
                'lat-pulldown': [0.35, 0.50, 0.65, 0.85, 1.10],
                'cable-row': [0.35, 0.50, 0.65, 0.85, 1.10],
                'leg-press': [1.00, 1.50, 2.00, 2.75, 3.50],
                'leg-curl': [0.15, 0.25, 0.35, 0.50, 0.65],
                'leg-extension': [0.20, 0.30, 0.40, 0.55, 0.75],
                'cable-fly': [0.08, 0.12, 0.18, 0.25, 0.35],
                'tricep-pushdown': [0.12, 0.18, 0.28, 0.40, 0.55]
            }
        };

        const LEVELS = ['Beginner', 'Novice', 'Intermediate', 'Advanced', 'Elite'];

        // State
        let activeWorkout = null;
        let workoutStartTime = null;
        let timerInterval = null;
        let currentPlan = null;

        // Helpers
        const get = key => JSON.parse(localStorage.getItem(key) || '[]');
        const getObj = key => JSON.parse(localStorage.getItem(key) || '{}');
        const set = (key, val) => localStorage.setItem(key, JSON.stringify(val));
        const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        const esc = text => { const d = document.createElement('div'); d.textContent = text || ''; return d.innerHTML; };

        function showToast(msg, type = '') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show ' + type;
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        // Initialize exercise library with user data
        function initExerciseLibrary() {
            let exercises = getObj(KEYS.exercises);

            // If empty or missing exercises, initialize from library
            if (Object.keys(exercises).length === 0) {
                exercises = {};
                Object.entries(EXERCISE_LIBRARY).forEach(([id, exercise]) => {
                    exercises[id] = {
                        ...exercise,
                        isCustom: false,
                        isFavorite: false,
                        workingWeight: null,
                        estimated1RM: null,
                        pr: {},
                        lastPerformed: null,
                        trend: 'stable'
                    };
                });
                set(KEYS.exercises, exercises);
            } else {
                // Add any new predefined exercises
                Object.entries(EXERCISE_LIBRARY).forEach(([id, exercise]) => {
                    if (!exercises[id]) {
                        exercises[id] = {
                            ...exercise,
                            isCustom: false,
                            isFavorite: false,
                            workingWeight: null,
                            estimated1RM: null,
                            pr: {},
                            lastPerformed: null,
                            trend: 'stable'
                        };
                    }
                });
                set(KEYS.exercises, exercises);
            }

            return exercises;
        }

        // Get exercise by ID
        function getExercise(exerciseId) {
            const exercises = getObj(KEYS.exercises);
            return exercises[exerciseId] || null;
        }

        // Update exercise data
        function updateExercise(exerciseId, updates) {
            const exercises = getObj(KEYS.exercises);
            if (exercises[exerciseId]) {
                exercises[exerciseId] = { ...exercises[exerciseId], ...updates };
                set(KEYS.exercises, exercises);
            }
        }

        // Migration from v3 to v4
        function migrateToV4() {
            // Check if already migrated
            if (localStorage.getItem(KEYS.exercises)) {
                return; // Already on v4
            }

            const oldTemplates = localStorage.getItem('iron_templates');
            const oldHistory = localStorage.getItem('iron_history');
            const oldProfile = localStorage.getItem('iron_profile');
            const oldEstimates = localStorage.getItem('iron_estimates');
            const oldPlans = localStorage.getItem('iron_plans');

            if (!oldTemplates && !oldHistory) {
                return; // Fresh install, no migration needed
            }

            console.log('Migrating to IRON v4...');

            // Migration mapping for old exercise IDs
            const exerciseIdMap = {
                'bench': 'bench-press',
                'squat': 'back-squat',
                'deadlift': 'deadlift',
                'ohp': 'overhead-press',
                'row': 'barbell-row',
                'front-squat': 'front-squat'
            };

            // Migrate templates
            if (oldTemplates) {
                try {
                    const templates = JSON.parse(oldTemplates);
                    const newTemplates = templates.map(t => ({
                        ...t,
                        exercises: t.exercises.map(e => ({
                            exerciseId: exerciseIdMap[e.id] || e.id,
                            isWarmup: false,
                            targetSets: e.sets,
                            targetReps: e.reps,
                            targetWeight: e.weight
                        }))
                    }));
                    set(KEYS.templates, newTemplates);
                } catch (err) {
                    console.error('Template migration error:', err);
                }
            }

            // Migrate history
            if (oldHistory) {
                try {
                    const history = JSON.parse(oldHistory);
                    const newHistory = history.map(w => ({
                        ...w,
                        exercises: w.exercises.map(e => {
                            const newId = exerciseIdMap[e.id] || e.id;
                            const exercise = EXERCISE_LIBRARY[newId];

                            if (exercise && exercise.category === 'cardio') {
                                return {
                                    exerciseId: newId,
                                    isWarmup: false,
                                    type: 'cardio',
                                    time: e.sets ? e.sets[0]?.reps : 10,
                                    resistance: 8
                                };
                            }

                            return {
                                exerciseId: newId,
                                isWarmup: false,
                                type: 'strength',
                                sets: e.sets || []
                            };
                        })
                    }));
                    set(KEYS.history, newHistory);
                } catch (err) {
                    console.error('History migration error:', err);
                }
            }

            // Copy profile and plans as-is
            if (oldProfile) localStorage.setItem(KEYS.profile, oldProfile);
            if (oldPlans) localStorage.setItem(KEYS.plans, oldPlans);

            console.log('Migration complete!');
            showToast('Upgraded to IRON v4!', 'success');
        }

        // Tab navigation
        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                document.getElementById('tab-' + tab).classList.add('active');
                document.getElementById('fab-btn').style.display = (tab === 'workout' && !activeWorkout) ? 'block' : 'none';
            });
        });

        // ===================== TEMPLATES =====================
        function renderTemplates() {
            const templates = get(KEYS.templates);
            const list = document.getElementById('template-list');

            if (templates.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <p class="empty-text">No templates yet. Create one to get started!</p>
                        <button type="button" class="btn btn-primary" onclick="openTemplateModal()" style="width: auto; padding: 12px 24px;">Create Template</button>
                    </div>`;
                return;
            }

            list.innerHTML = templates.map(t => {
                // Format exercise summary
                const exerciseSummary = t.exercises.map(e => {
                    const exercise = getExercise(e.exerciseId);
                    if (!exercise) return '';

                    if (exercise.category === 'cardio') {
                        return `${e.isWarmup ? '‚òÄ ' : ''}${exercise.name}: ${e.targetTime || 10}min`;
                    } else {
                        const weight = e.targetWeight || '';
                        return `${e.isWarmup ? '‚òÄ ' : ''}${exercise.name}: ${e.targetSets || 3}√ó${e.targetReps || 8}${weight ? ' @ ' + weight : ''}`;
                    }
                }).filter(s => s).join('<br>');

                return `
                    <div class="card">
                        <div class="card-title">${esc(t.name)}</div>
                        <div class="card-subtitle">${exerciseSummary || 'No exercises'}</div>
                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button type="button" class="btn btn-primary" style="flex: 1;" onclick="startWorkout('${t.id}')">Start</button>
                            <button type="button" class="btn btn-secondary" style="width: 50px;" onclick="openTemplateModal(null, '${t.id}')" aria-label="Copy template" title="Copy">‚éò</button>
                            <button type="button" class="btn btn-secondary" style="width: 50px;" onclick="openTemplateModal('${t.id}')" aria-label="Edit template" title="Edit">‚úé</button>
                        </div>
                    </div>`;
            }).join('');
        }

        // ===================== TEMPLATE SYSTEM v4 =====================
        let templateExercises = []; // Exercises added to current template

        // Render exercise categories in picker
        function renderExercisePicker(searchTerm = '') {
            const container = document.getElementById('exercise-categories');
            const exercises = getObj(KEYS.exercises);
            const term = searchTerm.toLowerCase();

            // Group exercises
            const favorites = Object.values(exercises).filter(e => e.isFavorite);
            const byEquipment = {
                barbell: [],
                dumbbell: [],
                kettlebell: [],
                cable: [],
                machine: [],
                bodyweight: [],
                cardio: []
            };

            Object.values(exercises).forEach(ex => {
                if (term && !ex.name.toLowerCase().includes(term)) return;

                if (ex.category === 'cardio') {
                    byEquipment.cardio.push(ex);
                } else {
                    if (byEquipment[ex.equipment]) {
                        byEquipment[ex.equipment].push(ex);
                    }
                }
            });

            let html = '';

            // Favorites
            if (favorites.length > 0 && !term) {
                html += '<div style="margin-bottom: 8px;"><strong style="color: var(--accent); font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">‚òÖ Favorites</strong><div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;">';
                favorites.forEach(ex => {
                    html += `<button type="button" class="exercise-pill" data-exercise-id="${ex.id}">${esc(ex.name)}</button>`;
                });
                html += '</div></div>';
            }

            // Strength categories
            const strengthCategories = [
                { key: 'barbell', label: 'Barbell' },
                { key: 'dumbbell', label: 'Dumbbell' },
                { key: 'kettlebell', label: 'Kettlebell' },
                { key: 'cable', label: 'Cable/Machine' },
                { key: 'bodyweight', label: 'Bodyweight' }
            ];

            strengthCategories.forEach(cat => {
                const list = byEquipment[cat.key];
                if (cat.key === 'cable') {
                    // Combine cable and machine
                    list.push(...byEquipment.machine);
                }

                if (list.length > 0) {
                    html += `<div style="margin-bottom: 8px;"><strong style="color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">${cat.label}</strong><div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;">`;
                    list.forEach(ex => {
                        html += `<button type="button" class="exercise-pill" data-exercise-id="${ex.id}">${esc(ex.name)}</button>`;
                    });
                    html += '</div></div>';
                }
            });

            // Cardio
            if (byEquipment.cardio.length > 0) {
                html += '<div style="margin-bottom: 8px;"><strong style="color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Cardio</strong><div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;">';
                byEquipment.cardio.forEach(ex => {
                    html += `<button type="button" class="exercise-pill" data-exercise-id="${ex.id}">${esc(ex.name)}</button>`;
                });
                html += '</div></div>';
            }

            container.innerHTML = html || '<p style="color: var(--text-muted); font-size: 12px;">No exercises found</p>';

            // Add click handlers
            container.querySelectorAll('.exercise-pill').forEach(btn => {
                btn.addEventListener('click', () => {
                    const exerciseId = btn.dataset.exerciseId;
                    addExerciseToTemplate(exerciseId);
                });
            });
        }

        // Add exercise to template
        function addExerciseToTemplate(exerciseId) {
            const exercise = getExercise(exerciseId);
            if (!exercise) return;

            const templateEx = {
                exerciseId: exercise.id,
                isWarmup: false,
                targetSets: 3,
                targetReps: 8,
                targetWeight: exercise.workingWeight || null,
                targetTime: null,
                targetResistance: null,
                targetSpeed: null,
                targetIncline: null,
                targetDistance: null
            };

            // Set cardio defaults
            if (exercise.category === 'cardio') {
                templateEx.targetTime = 10;
                templateEx.targetResistance = 8;
            }

            templateExercises.push(templateEx);
            renderTemplateExercises();
        }

        // Render added exercises in template
        function renderTemplateExercises() {
            const container = document.getElementById('template-exercises');

            if (templateExercises.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 12px; padding: 12px;">No exercises added yet. Select from above.</p>';
                return;
            }

            container.innerHTML = templateExercises.map((ex, idx) => {
                const exercise = getExercise(ex.exerciseId);
                if (!exercise) return '';

                const isCardio = exercise.category === 'cardio';
                const warmupChecked = ex.isWarmup ? 'checked' : '';

                let fields = '';
                if (isCardio) {
                    fields = `
                        <div class="exercise-field-row">
                            <div class="exercise-field-group">
                                <span class="exercise-field-label">Time (min)</span>
                                <input type="number" inputmode="numeric" class="exercise-field" data-idx="${idx}" data-field="targetTime" value="${ex.targetTime || 10}" min="1" max="120" step="1">
                            </div>
                            <div class="exercise-field-group">
                                <span class="exercise-field-label">Resistance</span>
                                <input type="number" inputmode="numeric" class="exercise-field" data-idx="${idx}" data-field="targetResistance" value="${ex.targetResistance || 8}" min="1" max="20" step="1">
                            </div>
                        </div>`;
                } else {
                    const workingWeight = exercise.workingWeight || '';
                    fields = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: var(--text-muted);">Working: ${workingWeight ? workingWeight + ' lbs' : 'Not set'}</span>
                            <button type="button" class="btn-text" data-idx="${idx}" data-action="autofill" style="font-size: 11px; padding: 4px 8px;">Auto-fill</button>
                        </div>
                        <div class="exercise-field-row">
                            <div class="exercise-field-group">
                                <span class="exercise-field-label">Sets</span>
                                <input type="number" inputmode="numeric" class="exercise-field" data-idx="${idx}" data-field="targetSets" value="${ex.targetSets || 3}" min="1" max="20" step="1">
                            </div>
                            <div class="exercise-field-group">
                                <span class="exercise-field-label">Reps</span>
                                <input type="number" inputmode="numeric" class="exercise-field" data-idx="${idx}" data-field="targetReps" value="${ex.targetReps || 8}" min="1" max="100" step="1">
                            </div>
                        </div>
                        <div class="exercise-field-group">
                            <span class="exercise-field-label">Weight (lbs)</span>
                            <input type="number" inputmode="decimal" class="exercise-field" data-idx="${idx}" data-field="targetWeight" placeholder="${workingWeight || '135'}" value="${ex.targetWeight || ''}" autocomplete="off">
                        </div>`;
                }

                return `
                    <div class="exercise-entry">
                        <div class="exercise-entry-header">
                            <div>
                                <span class="exercise-num">${ex.isWarmup ? '‚òÄ ' : ''}${esc(exercise.name)}</span>
                                <label style="display: block; font-size: 11px; color: var(--text-muted); margin-top: 2px; cursor: pointer;">
                                    <input type="checkbox" data-idx="${idx}" data-field="isWarmup" ${warmupChecked} style="margin-right: 4px;">
                                    Warmup
                                </label>
                            </div>
                            <button type="button" class="remove-btn" data-idx="${idx}" data-action="remove">√ó</button>
                        </div>
                        <div class="exercise-fields">
                            ${fields}
                        </div>
                    </div>`;
            }).join('');

            // Add event listeners
            container.querySelectorAll('input[data-idx]').forEach(input => {
                input.addEventListener('change', e => {
                    const idx = parseInt(e.target.dataset.idx);
                    const field = e.target.dataset.field;
                    if (field === 'isWarmup') {
                        templateExercises[idx][field] = e.target.checked;
                    } else {
                        templateExercises[idx][field] = e.target.type === 'number' ? (parseFloat(e.target.value) || null) : e.target.value;
                    }
                    renderTemplateExercises(); // Re-render to update warmup icon
                });
            });

            container.querySelectorAll('button[data-action="remove"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const idx = parseInt(btn.dataset.idx);
                    templateExercises.splice(idx, 1);
                    renderTemplateExercises();
                });
            });

            container.querySelectorAll('button[data-action="autofill"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const idx = parseInt(btn.dataset.idx);
                    const ex = templateExercises[idx];
                    const exercise = getExercise(ex.exerciseId);
                    if (exercise && exercise.workingWeight) {
                        ex.targetWeight = exercise.workingWeight;
                        renderTemplateExercises();
                        showToast('Auto-filled from working weight');
                    } else {
                        showToast('No working weight set for this exercise');
                    }
                });
            });
        }

        // Open template modal
        window.openTemplateModal = function(editId = null, copyId = null) {
            templateExercises = [];

            if (editId || copyId) {
                const t = get(KEYS.templates).find(x => x.id === (editId || copyId));
                if (t) {
                    if (editId) {
                        document.getElementById('template-modal-title').textContent = 'Edit Template';
                        document.getElementById('template-name').value = t.name;
                        document.getElementById('editing-template-id').value = editId;
                        document.getElementById('delete-template-btn').style.display = 'block';
                    } else {
                        document.getElementById('template-modal-title').textContent = 'Copy Template';
                        document.getElementById('template-name').value = t.name + ' (Copy)';
                        document.getElementById('editing-template-id').value = '';
                        document.getElementById('delete-template-btn').style.display = 'none';
                    }
                    templateExercises = [...t.exercises];
                }
            } else {
                document.getElementById('template-modal-title').textContent = 'New Template';
                document.getElementById('template-name').value = '';
                document.getElementById('editing-template-id').value = '';
                document.getElementById('delete-template-btn').style.display = 'none';
            }

            renderExercisePicker();
            renderTemplateExercises();
            document.getElementById('template-modal').classList.add('active');
        }

        // Search exercises
        document.getElementById('exercise-search').addEventListener('input', e => {
            renderExercisePicker(e.target.value);
        });

        // Custom exercise creation
        document.getElementById('create-custom-exercise-btn').addEventListener('click', () => {
            document.getElementById('custom-exercise-modal').classList.add('active');
        });

        document.getElementById('close-custom-exercise-modal').addEventListener('click', () => {
            document.getElementById('custom-exercise-modal').classList.remove('active');
        });

        document.getElementById('custom-exercise-form').addEventListener('submit', e => {
            e.preventDefault();
            const name = document.getElementById('custom-exercise-name').value.trim();
            const category = document.getElementById('custom-exercise-category').value;
            const equipment = document.getElementById('custom-exercise-equipment').value;
            const muscleGroup = document.getElementById('custom-exercise-muscle').value;

            if (!name) return;

            const exercises = getObj(KEYS.exercises);
            const id = 'custom-' + genId();

            exercises[id] = {
                id,
                name,
                category,
                equipment,
                muscleGroup,
                hasStandards: false,
                trackingType: category === 'cardio' ? 'cardio' : 'weight-reps',
                weightIncrement: 5,
                cardioFields: category === 'cardio' ? ['time', 'resistance'] : undefined,
                isCustom: true,
                isFavorite: false,
                workingWeight: null,
                estimated1RM: null,
                pr: {},
                lastPerformed: null,
                trend: 'stable'
            };

            set(KEYS.exercises, exercises);
            document.getElementById('custom-exercise-modal').classList.remove('active');
            document.getElementById('custom-exercise-form').reset();
            renderExercisePicker();
            showToast('Custom exercise created!', 'success');
        });

        // Modal close buttons
        document.getElementById('close-template-modal').addEventListener('click', () => {
            document.getElementById('template-modal').classList.remove('active');
        });

        document.getElementById('fab-btn').addEventListener('click', () => openTemplateModal());

        // Save template
        document.getElementById('template-form').addEventListener('submit', e => {
            e.preventDefault();
            const name = document.getElementById('template-name').value.trim();
            if (!name) return;

            if (templateExercises.length === 0) {
                showToast('Add at least one exercise');
                return;
            }

            const templates = get(KEYS.templates);
            const editId = document.getElementById('editing-template-id').value;

            if (editId) {
                const idx = templates.findIndex(t => t.id === editId);
                if (idx !== -1) {
                    templates[idx] = { ...templates[idx], name, exercises: templateExercises };
                }
            } else {
                templates.push({
                    id: genId(),
                    name,
                    exercises: templateExercises,
                    createdAt: new Date().toISOString(),
                    lastPerformed: null
                });
            }

            set(KEYS.templates, templates);
            renderTemplates();
            document.getElementById('template-modal').classList.remove('active');
            showToast(editId ? 'Template updated!' : 'Template created!', 'success');
        });

        // Delete template
        document.getElementById('delete-template-btn').addEventListener('click', () => {
            const editId = document.getElementById('editing-template-id').value;
            if (editId) {
                showConfirm('Delete this template?', function() {
                    set(KEYS.templates, get(KEYS.templates).filter(t => t.id !== editId));
                    renderTemplates();
                    document.getElementById('template-modal').classList.remove('active');
                    showToast('Template deleted');
                });
            }
        });

        // ===================== ACTIVE WORKOUT =====================
        window.startWorkout = function(templateId) {
            const t = get(KEYS.templates).find(x => x.id === templateId);
            if (!t) return;

            activeWorkout = {
                templateId: t.id,
                templateName: t.name,
                exercises: t.exercises.map(e => ({
                    name: e.name,
                    targetSets: parseInt(e.sets),
                    targetReps: e.reps,
                    targetWeight: e.weight,
                    sets: Array.from({ length: parseInt(e.sets) }, () => ({ weight: e.weight, reps: e.reps, completed: false }))
                }))
            };

            workoutStartTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
            renderActiveWorkout();

            document.getElementById('template-view').style.display = 'none';
            document.getElementById('active-workout').style.display = 'block';
            document.getElementById('fab-btn').style.display = 'none';
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000);
            document.getElementById('workout-timer').textContent =
                `${Math.floor(elapsed / 60).toString().padStart(2, '0')}:${(elapsed % 60).toString().padStart(2, '0')}`;
        }

        function renderActiveWorkout() {
            document.getElementById('active-workout-name').textContent = activeWorkout.templateName;
            document.getElementById('active-exercises').innerHTML = activeWorkout.exercises.map((ex, ei) => `
                <div class="exercise-block">
                    <div class="exercise-block-header">
                        <span class="exercise-block-name">${esc(ex.name)}</span>
                        <span class="exercise-block-target">${ex.targetSets}√ó${ex.targetReps} @ ${ex.targetWeight}</span>
                    </div>
                    <div class="set-list">
                        ${ex.sets.map((s, si) => `
                            <div class="set-row ${s.completed ? 'completed' : ''}" data-ei="${ei}" data-si="${si}">
                                <span class="set-num">${si + 1}</span>
                                <input type="text" inputmode="decimal" class="set-input" value="${s.weight}" onchange="updateSet(${ei},${si},'weight',this.value)" placeholder="Weight">
                                <input type="number" inputmode="numeric" class="set-input" style="width: 60px; flex: none;" value="${s.reps}" onchange="updateSet(${ei},${si},'reps',this.value)" min="1" max="100" placeholder="Reps">
                                <button type="button" class="set-check ${s.completed ? 'checked' : ''}" onclick="toggleSet(${ei},${si})" aria-label="Mark set complete">‚úì</button>
                            </div>
                        `).join('')}
                    </div>
                    <button class="add-set-btn" onclick="addSet(${ei})">+ Add Set</button>
                </div>
            `).join('');
        }

        window.updateSet = (ei, si, field, val) => { activeWorkout.exercises[ei].sets[si][field] = val; };
        window.toggleSet = (ei, si) => { activeWorkout.exercises[ei].sets[si].completed = !activeWorkout.exercises[ei].sets[si].completed; renderActiveWorkout(); };
        window.addSet = ei => { const ex = activeWorkout.exercises[ei]; const last = ex.sets[ex.sets.length - 1]; ex.sets.push({ weight: last.weight, reps: last.reps, completed: false }); renderActiveWorkout(); };

        // Custom confirm dialog (since native confirm() doesn't work in WebViews)
        let confirmCallback = null;

        function showConfirm(message, onYes) {
            document.getElementById('confirm-message').textContent = message;
            confirmCallback = onYes;
            document.getElementById('confirm-modal').classList.add('active');
        }

        document.getElementById('confirm-yes').addEventListener('click', function() {
            document.getElementById('confirm-modal').classList.remove('active');
            if (confirmCallback) confirmCallback();
            confirmCallback = null;
        });

        document.getElementById('confirm-no').addEventListener('click', function() {
            document.getElementById('confirm-modal').classList.remove('active');
            confirmCallback = null;
        });

        window.finishWorkout = function() {
            if (!activeWorkout) return;
            const history = get(KEYS.history);
            history.push({ id: genId(), templateId: activeWorkout.templateId, templateName: activeWorkout.templateName, exercises: activeWorkout.exercises, date: new Date().toISOString(), duration: Date.now() - workoutStartTime });
            set(KEYS.history, history);
            endWorkout();
            renderHistory();
            showToast('Workout saved!', 'success');
        };

        window.cancelWorkout = function() {
            showConfirm('Cancel workout? Progress will be lost.', function() {
                endWorkout();
            });
        };

        // Attach event listeners for finish and cancel buttons
        document.getElementById('finish-btn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            window.finishWorkout();
        });

        document.getElementById('cancel-btn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            window.cancelWorkout();
        });

        function endWorkout() {
            activeWorkout = null;
            clearInterval(timerInterval);
            document.getElementById('active-workout').style.display = 'none';
            document.getElementById('template-view').style.display = 'block';
            document.getElementById('fab-btn').style.display = 'block';
        }

        // ===================== HISTORY =====================
        function renderHistory() {
            const history = get(KEYS.history).sort((a, b) => new Date(b.date) - new Date(a.date));
            const list = document.getElementById('history-list');

            if (history.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div><p class="empty-text">No workouts logged yet.</p></div>';
                return;
            }

            list.innerHTML = history.map(w => {
                const date = new Date(w.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
                const summary = w.exercises.map(e => `${e.name}: ${e.sets.filter(s => s.completed).length} sets`).join(', ');
                return `<div class="history-card" onclick="viewWorkout('${w.id}')"><div class="history-header"><span class="history-name">${esc(w.templateName)}</span><span class="history-date">${date}</span></div><div class="history-summary">${summary}</div></div>`;
            }).join('');
        }

        window.viewWorkout = id => {
            const w = get(KEYS.history).find(x => x.id === id);
            if (!w) return;
            document.getElementById('workout-modal-title').textContent = w.templateName;
            document.getElementById('workout-modal-date').textContent = new Date(w.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit' });
            document.getElementById('workout-modal-exercises').innerHTML = w.exercises.map(e => `
                <div class="card" style="margin-bottom: 10px;"><div class="card-title">${esc(e.name)}</div>
                <div class="card-subtitle">${e.sets.filter(s => s.completed).map((s, i) => `Set ${i + 1}: ${s.weight} √ó ${s.reps}`).join('<br>') || 'No sets completed'}</div></div>
            `).join('');
            document.getElementById('delete-workout-btn').onclick = () => {
                showConfirm('Delete this workout?', function() {
                    set(KEYS.history, get(KEYS.history).filter(x => x.id !== id));
                    renderHistory();
                    document.getElementById('workout-modal').classList.remove('active');
                    showToast('Workout deleted');
                });
            };
            document.getElementById('workout-modal').classList.add('active');
        };

        document.getElementById('close-workout-modal').addEventListener('click', () => document.getElementById('workout-modal').classList.remove('active'));

        // ===================== 1RM CALCULATOR =====================
        function getProfile() { return getObj(KEYS.profile); }

        function loadProfile() {
            const p = getProfile();
            if (p.weight) document.getElementById('profile-weight').value = p.weight;
            if (p.sex) document.getElementById('profile-sex').value = p.sex;
            updateStandardsTable();
        }

        document.getElementById('save-profile-btn').addEventListener('click', () => {
            const weight = parseFloat(document.getElementById('profile-weight').value);
            const sex = document.getElementById('profile-sex').value;
            if (!weight) { showToast('Enter your body weight'); return; }
            set(KEYS.profile, { weight, sex });
            showToast('Profile saved!', 'success');
            updateStandardsTable();
            calculate1RM();
        });

        function calculate1RM() {
            const weight = parseFloat(document.getElementById('calc-weight').value);
            const reps = parseInt(document.getElementById('calc-reps').value);
            const exercise = document.getElementById('calc-exercise').value;

            if (!weight || !reps) {
                document.getElementById('calc-1rm').textContent = '‚Äî';
                document.getElementById('calc-current-pct').textContent = '‚Äî';
                document.getElementById('percentage-grid').innerHTML = '';
                document.getElementById('standards-display').style.display = 'none';
                document.getElementById('save-1rm-btn').style.display = 'none';
                document.getElementById('current-weight-info').style.display = 'none';
                return;
            }

            const oneRM = reps === 1 ? weight : Math.round(weight * (1 + reps / 30));
            const currentPct = Math.round((weight / oneRM) * 100);

            document.getElementById('calc-1rm').textContent = oneRM;
            document.getElementById('calc-current-pct').textContent = currentPct + '%';
            document.getElementById('save-1rm-btn').style.display = 'block';

            // Show current weight info
            document.getElementById('current-weight-info').style.display = 'block';
            document.getElementById('info-weight').textContent = weight;
            document.getElementById('info-pct').textContent = currentPct + '%';

            // Determine rep range based on percentage
            let repRange, rangeDesc;
            if (currentPct >= 90) { repRange = '1-3 reps'; rangeDesc = 'strength/power'; }
            else if (currentPct >= 80) { repRange = '4-6 reps'; rangeDesc = 'strength'; }
            else if (currentPct >= 70) { repRange = '6-10 reps'; rangeDesc = 'strength-hypertrophy'; }
            else if (currentPct >= 60) { repRange = '10-15 reps'; rangeDesc = 'hypertrophy'; }
            else { repRange = '15+ reps'; rangeDesc = 'endurance'; }
            document.getElementById('info-rep-range').textContent = `${repRange} (${rangeDesc})`;

            // Percentages grid - highlight the user's current percentage range
            const percentages = [95, 90, 85, 80, 75, 70, 65, 60, 55];
            document.getElementById('percentage-grid').innerHTML = percentages.map(p => {
                const isNear = Math.abs(p - currentPct) <= 5;
                return `<div class="pct-item ${isNear ? 'active' : ''}"><div class="pct-value">${Math.round(oneRM * p / 100)}</div><div class="pct-label">${p}%</div></div>`;
            }).join('');

            // Standards
            const profile = getProfile();
            if (profile.weight) {
                const stds = STANDARDS[profile.sex][exercise];
                if (stds) {
                    const thresholds = stds.map(m => Math.round(m * profile.weight));
                    let level = 0;
                    for (let i = 0; i < thresholds.length; i++) if (oneRM >= thresholds[i]) level = i;

                    let pct;
                    if (oneRM < thresholds[0]) pct = (oneRM / thresholds[0]) * 20;
                    else if (level === 4) pct = 80 + Math.min(20, 20);
                    else pct = level * 20 + 20 + ((oneRM - thresholds[level]) / (thresholds[level + 1] - thresholds[level])) * 20;

                    document.getElementById('standards-marker').style.left = `${Math.min(98, Math.max(2, pct))}%`;
                    document.getElementById('standards-display').style.display = 'block';

                    let info = `<strong style="color: ${['#64748b','#3b82f6','#16a34a','#eab308','#ef4444'][level]}">${LEVELS[level]}</strong>`;
                    if (level < 4) info += ` ‚Äî ${thresholds[level + 1] - oneRM} lbs to ${LEVELS[level + 1]}`;
                    document.getElementById('standards-info').innerHTML = info;
                }
            }
        }

        document.getElementById('calc-exercise').addEventListener('change', calculate1RM);
        document.getElementById('calc-weight').addEventListener('input', calculate1RM);
        document.getElementById('calc-reps').addEventListener('input', calculate1RM);

        document.getElementById('save-1rm-btn').addEventListener('click', () => {
            const exercise = document.getElementById('calc-exercise').value;
            const oneRM = parseInt(document.getElementById('calc-1rm').textContent);
            const weight = document.getElementById('calc-weight').value;
            const reps = document.getElementById('calc-reps').value;
            if (!oneRM || oneRM === '‚Äî') return;

            const estimates = getObj(KEYS.estimates);
            estimates[exercise] = { oneRM, basedOn: `${weight}√ó${reps}`, date: new Date().toISOString() };
            set(KEYS.estimates, estimates);
            showToast(`${EXERCISES[exercise]} 1RM saved!`, 'success');
            updateStandardsTable();
        });

        function updateStandardsTable() {
            const profile = getProfile();
            const container = document.getElementById('standards-table');
            if (!profile.weight) {
                container.innerHTML = '<p style="font-size: 12px; color: var(--text-muted);">Enter body weight to see standards.</p>';
                return;
            }

            const estimates = getObj(KEYS.estimates);
            const exercises = ['bench', 'squat', 'deadlift', 'ohp', 'row'];

            container.innerHTML = `
                <div class="standards-row header"><div class="standards-cell name">Exercise</div><div class="standards-cell">Beg</div><div class="standards-cell">Nov</div><div class="standards-cell">Int</div><div class="standards-cell">Adv</div><div class="standards-cell">Elite</div></div>
                ${exercises.map(ex => {
                    const stds = STANDARDS[profile.sex][ex];
                    const current = estimates[ex]?.oneRM;
                    let currentLevel = -1;
                    if (current) {
                        for (let i = 0; i < stds.length; i++) if (current >= Math.round(stds[i] * profile.weight)) currentLevel = i;
                    }
                    return `<div class="standards-row"><div class="standards-cell name">${EXERCISES[ex]}</div>${stds.map((m, i) => {
                        const val = Math.round(m * profile.weight);
                        const work = Math.round(val * 0.7);
                        return `<div class="standards-cell ${currentLevel === i ? 'current' : ''}">${val}<div class="working">(${work})</div></div>`;
                    }).join('')}</div>`;
                }).join('')}
            `;
        }

        // ===================== PROGRESS PLANNER =====================
        window.loadExerciseData = function() {
            const exercise = document.getElementById('plan-exercise').value;
            const estimates = getObj(KEYS.estimates);
            const estimate = estimates[exercise];
            const profile = getProfile();

            const statsBox = document.getElementById('current-stats');
            const warningBox = document.getElementById('no-estimate-warning');
            const currentInput = document.getElementById('plan-current');
            const goalSuggestions = document.getElementById('goal-suggestions');
            const goalChips = document.getElementById('goal-chips');

            if (estimate && estimate.oneRM) {
                // Use the actual weight they lifted (from basedOn), not 70%
                let actualWeight = null;
                if (estimate.basedOn) {
                    const match = estimate.basedOn.match(/^(\d+)/);
                    if (match) actualWeight = parseInt(match[1]);
                }

                const working70 = Math.round(estimate.oneRM * 0.7);
                const currentWeight = actualWeight || working70;

                document.getElementById('plan-current-1rm').textContent = estimate.oneRM;
                document.getElementById('plan-current-working').textContent = currentWeight;

                currentInput.value = currentWeight;
                currentInput.placeholder = currentWeight;

                const statsLabel = document.querySelector('.current-stats-label');
                if (actualWeight) {
                    statsLabel.innerHTML = `From your saved estimate (${estimate.basedOn}):`;
                } else {
                    statsLabel.innerHTML = 'From your saved 1RM:';
                }

                statsBox.style.display = 'block';
                warningBox.style.display = 'none';

                // Generate goal suggestions
                const goals = [];

                // Plate milestones (common barbell weights)
                const plateMilestones = [95, 115, 135, 155, 185, 205, 225, 275, 315, 365, 405];
                const nextMilestones = plateMilestones.filter(m => m > currentWeight && m <= currentWeight + 100);
                nextMilestones.slice(0, 2).forEach(m => {
                    goals.push({ weight: m, label: 'Plate milestone', type: 'milestone' });
                });

                // Strength level goals from standards
                if (profile.weight) {
                    const stds = STANDARDS[profile.sex]?.[exercise];
                    if (stds) {
                        // Find current level based on 1RM
                        let currentLevel = -1;
                        const thresholds1RM = stds.map(m => Math.round(m * profile.weight));
                        for (let i = 0; i < thresholds1RM.length; i++) {
                            if (estimate.oneRM >= thresholds1RM[i]) currentLevel = i;
                        }

                        // Suggest next level(s) as working weight (80% of 1RM threshold)
                        for (let i = currentLevel + 1; i < Math.min(currentLevel + 3, thresholds1RM.length); i++) {
                            const targetWorking = Math.round(thresholds1RM[i] * 0.8); // 80% for ~8 rep range
                            if (targetWorking > currentWeight) {
                                goals.push({
                                    weight: targetWorking,
                                    label: LEVELS[i] + ' level',
                                    type: i === currentLevel + 1 ? 'next' : 'level'
                                });
                            }
                        }
                    }
                }

                // Simple incremental goals (+10, +25, +50)
                const increments = [
                    { add: 10, label: '+10 lbs' },
                    { add: 25, label: '+25 lbs' },
                    { add: 50, label: '+50 lbs' }
                ];
                increments.forEach(inc => {
                    const target = currentWeight + inc.add;
                    // Only add if not already suggested
                    if (!goals.find(g => Math.abs(g.weight - target) < 5)) {
                        goals.push({ weight: target, label: inc.label, type: '' });
                    }
                });

                // Sort by weight and remove duplicates
                goals.sort((a, b) => a.weight - b.weight);
                const uniqueGoals = goals.filter((g, i, arr) =>
                    i === 0 || Math.abs(g.weight - arr[i-1].weight) >= 5
                ).slice(0, 6);

                if (uniqueGoals.length > 0) {
                    goalChips.innerHTML = uniqueGoals.map(g => `
                        <button type="button" class="goal-chip ${g.type}" onclick="document.getElementById('plan-goal').value=${g.weight}">
                            <strong>${g.weight}</strong>
                            <span class="chip-label">${g.label}</span>
                        </button>
                    `).join('');
                    goalSuggestions.style.display = 'block';
                } else {
                    goalSuggestions.style.display = 'none';
                }

            } else {
                statsBox.style.display = 'none';
                warningBox.style.display = 'flex';
                goalSuggestions.style.display = 'none';
                currentInput.value = '';
                currentInput.placeholder = 'Enter weight';
            }

            // Clear timeline when exercise changes
            document.getElementById('progress-timeline').style.display = 'none';
        }

        // Load data when tab is shown
        document.querySelector('[data-tab="progress"]').addEventListener('click', () => {
            setTimeout(loadExerciseData, 100);
        });

        document.getElementById('generate-plan-btn').addEventListener('click', () => {
            const exercise = document.getElementById('plan-exercise').value;
            const currentWorking = parseFloat(document.getElementById('plan-current').value);
            const goalWorking = parseFloat(document.getElementById('plan-goal').value);
            const frequency = parseInt(document.getElementById('plan-frequency').value);
            const increment = parseFloat(document.getElementById('plan-increment').value);

            if (!currentWorking || !goalWorking || goalWorking <= currentWorking) {
                showToast('Enter valid current and goal weights');
                return;
            }

            const totalGain = goalWorking - currentWorking;
            const weeks = Math.ceil(totalGain / increment);

            // Calculate implied 1RMs (working weight is 70% of 1RM)
            const current1RM = Math.round(currentWorking / 0.7);
            const goal1RM = Math.round(goalWorking / 0.7);

            currentPlan = {
                exercise,
                currentWorking,
                goalWorking,
                current1RM,
                goal1RM,
                frequency,
                increment,
                weeks
            };

            const timeline = document.getElementById('progress-timeline');
            timeline.style.display = 'block';

            let html = `
                <div style="margin: 14px 0; padding: 14px; background: var(--bg); border-radius: 10px;">
                    <div style="font-weight: 600; margin-bottom: 6px;">${EXERCISES[exercise]} Progression</div>
                    <div style="font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                        Working weight: <strong style="color: var(--text);">${currentWorking} ‚Üí ${goalWorking} lbs</strong><br>
                        Implied 1RM: ${current1RM} ‚Üí ${goal1RM} lbs<br>
                        Duration: <strong style="color: var(--accent);">${weeks} weeks</strong> (${frequency}√ó/week, +${increment} lbs/week)
                    </div>
                </div>
            `;

            // Calculate plate suggestions for key milestones
            html += '<div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Week-by-Week Plan</div>';

            for (let w = 0; w <= weeks; w++) {
                const weekWorking = Math.min(goalWorking, currentWorking + (increment * w));
                const week1RM = Math.round(weekWorking / 0.7);
                const progress = ((weekWorking - currentWorking) / totalGain) * 100;
                const isCurrent = w === 0;
                const isGoal = weekWorking >= goalWorking;

                html += `
                    <div class="progress-week ${isCurrent ? 'current' : ''}">
                        <span class="progress-week-num">${w === 0 ? 'Now' : 'Wk ' + w}</span>
                        <span class="progress-week-weight">${weekWorking} lbs</span>
                        <span class="progress-week-working" style="font-size: 11px; color: var(--text-muted);">1RM: ${week1RM}</span>
                        <div class="progress-week-bar"><div class="progress-week-fill" style="width: ${progress}%"></div></div>
                    </div>
                `;
            }

            html += `<button class="btn btn-secondary" style="margin-top: 14px;" onclick="openSavePlanModal()">Save This Plan</button>`;
            timeline.innerHTML = html;
        });

        window.openSavePlanModal = () => {
            if (!currentPlan) return;
            document.getElementById('plan-name').value = `${EXERCISES[currentPlan.exercise]} to ${currentPlan.goalWorking} lbs`;
            document.getElementById('plan-modal').classList.add('active');
        };

        document.getElementById('close-plan-modal').addEventListener('click', () => document.getElementById('plan-modal').classList.remove('active'));

        document.getElementById('confirm-save-plan').addEventListener('click', () => {
            const name = document.getElementById('plan-name').value.trim();
            if (!name || !currentPlan) return;

            const plans = get(KEYS.plans);
            plans.push({
                id: genId(),
                name,
                ...currentPlan,
                createdAt: new Date().toISOString(),
                currentWeek: 0
            });
            set(KEYS.plans, plans);
            document.getElementById('plan-modal').classList.remove('active');
            renderSavedPlans();
            showToast('Plan saved!', 'success');
        });

        function renderSavedPlans() {
            const plans = get(KEYS.plans);
            const container = document.getElementById('saved-plans-list');

            if (plans.length === 0) {
                container.innerHTML = '<p style="font-size: 13px; color: var(--text-muted);">No saved plans yet.</p>';
                return;
            }

            container.innerHTML = plans.map(p => {
                const progress = Math.min(100, (p.currentWeek / p.weeks) * 100);
                const currentWeight = Math.min(p.goalWorking, p.currentWorking + (p.increment * p.currentWeek));
                const isComplete = p.currentWeek >= p.weeks;

                return `
                    <div class="plan-card">
                        <div class="plan-header">
                            <span class="plan-name">${esc(p.name)}</span>
                            <button class="remove-btn" onclick="deletePlan('${p.id}')" style="width: 24px; height: 24px; font-size: 12px;">√ó</button>
                        </div>
                        <div class="plan-meta">${EXERCISES[p.exercise]}: ${p.currentWorking} ‚Üí ${p.goalWorking} lbs working weight</div>
                        <div class="plan-meta">Week ${p.currentWeek}/${p.weeks} ‚Ä¢ This week: <strong style="color: var(--text);">${currentWeight} lbs</strong></div>
                        <div class="plan-progress">
                            <div class="plan-progress-bar"><div class="plan-progress-fill" style="width: ${progress}%"></div></div>
                            <span class="plan-progress-text">${isComplete ? '‚úì Complete!' : Math.round(progress) + '% done'}</span>
                        </div>
                        ${!isComplete ? `<button class="btn btn-secondary" style="margin-top: 10px;" onclick="advancePlan('${p.id}')">Complete Week ${p.currentWeek + 1} ‚Üí</button>` : ''}
                    </div>
                `;
            }).join('');
        }

        window.advancePlan = id => {
            const plans = get(KEYS.plans);
            const plan = plans.find(p => p.id === id);
            if (plan && plan.currentWeek < plan.weeks) {
                plan.currentWeek++;
                set(KEYS.plans, plans);
                renderSavedPlans();

                if (plan.currentWeek >= plan.weeks) {
                    showToast('üéâ Plan complete! You did it!', 'success');
                } else {
                    const nextWeight = Math.min(plan.goalWorking, plan.currentWorking + (plan.increment * plan.currentWeek));
                    showToast(`Week ${plan.currentWeek} done! Next: ${nextWeight} lbs`, 'success');
                }
            }
        };

        window.deletePlan = id => {
            showConfirm('Delete this plan?', function() {
                set(KEYS.plans, get(KEYS.plans).filter(p => p.id !== id));
                renderSavedPlans();
                showToast('Plan deleted');
            });
        };

        // ===================== SETTINGS =====================
        document.getElementById('settings-btn').addEventListener('click', () => {
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-settings').classList.add('active');
            document.getElementById('fab-btn').style.display = 'none';
        });

        document.getElementById('export-btn').addEventListener('click', () => {
            const data = { templates: get(KEYS.templates), history: get(KEYS.history), profile: getObj(KEYS.profile), estimates: getObj(KEYS.estimates), plans: get(KEYS.plans) };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `iron-backup-${new Date().toISOString().split('T')[0]}.json`; a.click();
            showToast('Exported!', 'success');
        });

        document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-input').click());
        document.getElementById('import-input').addEventListener('change', e => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (data.templates) set(KEYS.templates, data.templates);
                    if (data.history) set(KEYS.history, data.history);
                    if (data.profile) set(KEYS.profile, data.profile);
                    if (data.estimates) set(KEYS.estimates, data.estimates);
                    if (data.plans) set(KEYS.plans, data.plans);
                    renderTemplates(); renderHistory(); loadProfile(); renderSavedPlans();
                    showToast('Imported!', 'success');
                } catch { showToast('Invalid file'); }
            };
            reader.readAsText(file); e.target.value = '';
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
            showConfirm('Delete ALL data? This cannot be undone.', function() {
                Object.values(KEYS).forEach(k => localStorage.removeItem(k));
                renderTemplates(); renderHistory(); renderSavedPlans();
                document.getElementById('profile-weight').value = '';
                showToast('Data cleared');
            });
        });

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); }));

        // Init - IRON v4
        migrateToV4();  // Migrate old data if present
        initExerciseLibrary();  // Initialize exercise library
        renderTemplates();
        renderHistory();
        loadProfile();
        renderSavedPlans();
        if (typeof loadExerciseData === 'function') loadExerciseData();

        // Register service worker for offline support
        if ('serviceWorker' in navigator) {
            // Create a minimal service worker inline for caching
            const swCode = `
                const CACHE_NAME = 'iron-v1';
                self.addEventListener('install', e => self.skipWaiting());
                self.addEventListener('activate', e => e.waitUntil(clients.claim()));
                self.addEventListener('fetch', e => {
                    if (e.request.method !== 'GET') return;
                    e.respondWith(
                        caches.match(e.request).then(r => r || fetch(e.request).then(res => {
                            if (res.ok && e.request.url.startsWith(self.location.origin)) {
                                const clone = res.clone();
                                caches.open(CACHE_NAME).then(c => c.put(e.request, clone));
                            }
                            return res;
                        }))
                    );
                });
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(() => {});
        }
    </script>
</body>
</html>
